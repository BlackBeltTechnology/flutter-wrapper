#!/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

if [[ ! -d flutter ]]; then
  echo "Flutter not found, installing..."
  git clone https://github.com/flutter/flutter.git -b beta --depth 1 $SCRIPT_DIR/flutter
  $SCRIPT_DIR/flutter/bin/flutter doctor
fi
if [[ ! -f $SCRIPT_DIR/chromew ]]; then
  base64 -d <<<IyEvYmluL3NoCmlmIFtbICIkT1NUWVBFIiA9PSAiZGFyd2luIiogXV07IHRoZW4KICBDSFJPTUVfQklOPS9BcHBsaWNhdGlvbnMvR29vZ2xlXCBDaHJvbWUuYXBwL0NvbnRlbnRzL01hY09TL0dvb2dsZVwgQ2hyb21lCmVsaWYgW1sgIiRPU1RZUEUiID09ICJsaW51eC1nbnUiKiBdXTsgdGhlbgogIENIUk9NRV9CSU49JCh3aGljaCBnb29nbGUtY2hyb21lKQplbHNlCiAgZWNobyAiVW5zdXBwb3J0ZWQgT1MiCiAgZXhpdCAxCmZpCgplY2hvICJDaHJvbWU6ICRDSFJPTUVfQklOIgppZiBbWyAhIC1mICIke0NIUk9NRV9CSU59IiBdXTsgdGhlbgogIGVjaG8gIkdvb2dsZSBjaHJvbWUgbm90IGZvdW5kIgogIGV4aXQgMQpmaQoKI2V4ZSBjIGJhc2ggLWMgImV4ZWMgJHtDSFJPTUVfQklOfSAtLWRpc2FibGUtd2ViLXNlY3VyaXR5IC0tdXNlci1kYXRhLWRpcj1cIi5jaHJvbWVcIiAkKiIKCiIkQ0hST01FX0JJTiIgLS1kaXNhYmxlLXdlYi1zZWN1cml0eSAtLXVzZXItZGF0YS1kaXI9Ii5jaHJvbWUiICQqCg== > $SCRIPT_DIR/chromew
  chmod +x $SCRIPT_DIR/chromew
fi
if [[ ! -f $SCRIPT_DIR/Chromew.ps1 ]]; then
  base64 -d <<<ImM6XFByb2dyYW0gRmlsZXMgKHg4NilcR29vZ2xlXENocm9tZVxBcHBsaWNhdGlvblxjaHJvbWUuZXhlIiAtLWRpc2FibGUtd2ViLXNlY3VyaXR5IC0tdXNlci1kYXRhLWRpcj0iLmNocm9tZSIgJSo= > $SCRIPT_DIR/Chromew.ps1
fi
export CHROME_EXECUTABLE="$SCRIPT_DIR/chromew"
$SCRIPT_DIR/flutter/bin/flutter $*
