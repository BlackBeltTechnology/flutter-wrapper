#!/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

if [[ ! -d $SCRIPT_DIR/.flutter ]]; then
  echo "Flutter not found, installing..."
  git clone https://github.com/flutter/flutter.git -b beta --depth 1 $SCRIPT_DIR/.flutter
  $SCRIPT_DIR/.flutter/bin/flutter doctor
fi
if [[ ! -f $SCRIPT_DIR/chromew ]]; then
  base64 -d <<<IyEvYmluL3NoCmlmIFsgImB1bmFtZWAiID0gIkRhcndpbiIgXTsgdGhlbgogIENIUk9NRV9CSU49L0FwcGxpY2F0aW9ucy9Hb29nbGVcIENocm9tZS5hcHAvQ29udGVudHMvTWFjT1MvR29vZ2xlXCBDaHJvbWUKZWxpZiBbICJgdW5hbWVgIiA9ICJMaW51eCIgXTsgdGhlbgogIENIUk9NRV9CSU49JCh3aGljaCBnb29nbGUtY2hyb21lKQplbHNlCiAgZWNobyAiVW5zdXBwb3J0ZWQgT1MiCiAgZXhpdCAxCmZpCgplY2hvICJDaHJvbWU6ICRDSFJPTUVfQklOIgppZiBbICEgLWYgIiR7Q0hST01FX0JJTn0iIF07IHRoZW4KICBlY2hvICJHb29nbGUgY2hyb21lIG5vdCBmb3VuZCIKICBleGl0IDEKZmkKCiNleGUgYyBiYXNoIC1jICJleGVjICR7Q0hST01FX0JJTn0gLS1kaXNhYmxlLXdlYi1zZWN1cml0eSAtLXVzZXItZGF0YS1kaXI9XCIuY2hyb21lXCIgJCoiCgoiJENIUk9NRV9CSU4iIC0tZGlzYWJsZS13ZWItc2VjdXJpdHkgLS11c2VyLWRhdGEtZGlyPSIuY2hyb21lIiAkKg== > $SCRIPT_DIR/chromew
  chmod +x $SCRIPT_DIR/chromew
fi
if [[ ! -f $SCRIPT_DIR/Chromew.cmd ]]; then
  base64 -d <<<ImM6XFByb2dyYW0gRmlsZXMgKHg4NilcR29vZ2xlXENocm9tZVxBcHBsaWNhdGlvblxjaHJvbWUuZXhlIiAtLWRpc2FibGUtd2ViLXNlY3VyaXR5IC0tdXNlci1kYXRhLWRpcj0iLmNocm9tZSIgJSo= > $SCRIPT_DIR/Chromew.cmd
fi
export CHROME_EXECUTABLE="$SCRIPT_DIR/chromew"
$SCRIPT_DIR/.flutter/bin/flutter $*
